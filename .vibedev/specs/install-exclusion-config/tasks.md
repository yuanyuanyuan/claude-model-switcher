# 安装排除配置功能 - 任务规划

## 实施计划

### 1. 文件排除功能核心实现

- [x] **1.1 实现排除规则解析函数**
  - 在 `install.sh` 中添加 `parse_exclusion_file()` 函数
  - 支持读取 `.claude-exclude` 配置文件
  - 处理注释行和空行
  - 引用需求: 1.1, 1.2, 2.1, 2.2

- [x] **1.2 实现文件匹配检查函数**
  - 在 `install.sh` 中添加 `is_file_excluded()` 函数
  - 支持通配符模式匹配 (`*.log`, `temp_*`)
  - 支持目录排除 (`docs/`)
  - 支持否定规则 (`!README.md`)
  - 引用需求: 1.3, 2.1, 2.3

- [x] **1.3 实现智能文件复制函数**
  - 在 `install.sh` 中添加 `copy_with_exclusion()` 函数
  - 使用 `find` + `print0` 安全处理文件路径
  - 应用排除规则进行文件过滤
  - 引用需求: 1.2, 1.4, 1.5

### 2. 安装流程集成

- [x] **2.1 修改 `bootstrap_install()` 函数**
  - 在文件复制阶段调用排除功能
  - 添加环境变量 `IGNORE_EXCLUDE` 支持
  - 保持向后兼容性（配置文件不存在时使用默认行为）
  - 引用需求: 1.1, 1.2, 3.1, 3.2, 5.1, 5.2

- [x] **2.2 添加排除功能配置检查**
  - 在安装开始时检查 `.claude-exclude` 文件
  - 记录排除规则加载状态
  - 引用需求: 3.1, 3.3, 6.1, 6.3

### 3. 卸载提示禁用

- [x] **3.1 修改 `main.sh` 中的卸载逻辑**
  - 定位 `cmd_uninstall()` 函数中的Claude Code CLI卸载提示
  - 移除用户交互提示代码块
  - 添加日志说明禁用原因
  - 引用需求: 4.1, 4.2, 4.3

- [x] **3.2 验证卸载功能完整性**
  - 确保其他卸载逻辑不受影响
  - 验证Claude Code CLI保持安装状态
  - 引用需求: 4.2, 5.3

### 4. 错误处理和日志

- [ ] **4.1 添加排除功能错误处理**
  - 配置文件读取失败时的错误处理
  - 规则解析错误的警告记录
  - 文件复制错误的适当处理
  - 引用需求: 1.4, 6.1, 6.2

- [ ] **4.2 增强日志记录**
  - 添加排除规则加载日志
  - 记录被排除的文件列表
  - 添加调试级别的详细日志
  - 引用需求: 6.3

### 5. 测试实现

- [x] **5.1 创建排除规则解析单元测试**
  - 测试各种规则格式的解析
  - 验证注释和空行处理
  - 引用需求: 1.1, 1.2

- [x] **5.2 创建文件匹配逻辑单元测试**
  - 测试通配符匹配准确性
  - 验证目录排除逻辑
  - 测试否定规则优先级
  - 引用需求: 1.3, 2.1

- [x] **5.3 创建集成测试**
  - 测试完整安装流程中的排除功能
  - 验证配置文件不同状态下的行为
  - 测试错误场景的处理
  - 引用需求: 1.5, 3.4, 6.1

- [ ] **5.4 创建BDD测试场景**
  - "当存在.claude-exclude配置文件时，应该在安装过程中排除指定的文件"
  - "应该正确处理通配符规则和目录排除"
  - "卸载时不应该询问是否卸载Claude Code CLI"
  - 引用需求: 所有用户故事

### 6. 配置和文档

- [x] **6.1 创建示例配置文件**
  - 创建 `.claude-exclude.example` 示例文件
  - 包含各种规则语法的示例
  - 引用需求: 2.1, 3.2

- [x] **6.2 更新主README文档**
  - 添加文件排除功能说明
  - 提供配置示例和使用指南
  - 说明卸载提示的变化
  - 引用需求: 所有非功能性需求

### 7. 质量保证

- [ ] **7.1 运行所有现有测试**
  - 确保新功能不破坏现有功能
  - 验证向后兼容性
  - 引用需求: 5.1, 5.2, 5.3

- [ ] **7.2 执行代码审查和质量检查**
  - 验证代码符合项目标准
  - 检查错误处理完整性
  - 确保日志记录适当
  - 引用需求: 所有非功能性需求

## 实施顺序建议

1. **首先实现核心功能** (任务1.1-1.3)
2. **然后集成到安装流程** (任务2.1-2.2) 
3. **接着处理卸载提示** (任务3.1-3.2)
4. **添加错误处理和日志** (任务4.1-4.2)
5. **实现测试覆盖** (任务5.1-5.4)
6. **最后更新文档** (任务6.1-6.2)
7. **进行质量验证** (任务7.1-7.2)

## 依赖关系

- 任务1.1-1.3 是核心基础，必须先完成
- 任务2.1-2.2 依赖任务1.1-1.3
- 任务5.1-5.4 依赖功能实现完成
- 任务6.1-6.2 应该在功能稳定后完成

这个任务规划确保了功能的完整实现，同时遵循测试驱动开发和增量实现的原则。