# 安装目录配置任务清单

## 1. 修改安装脚本核心配置

- [x] **1.1 修改 INSTALL_TARGET 变量定义**
  - 文件: `install.sh`
  - 将硬编码的 `INSTALL_TARGET="$HOME/.claude/claude-model-switcher"` 改为支持环境变量
  - 默认值设置为 `/root/claude-model-switcher`
  - 参考需求: 1.1.2 (默认安装目录设置)

- [x] **1.2 添加环境变量支持**
  - 文件: `install.sh`
  - 实现 `CLAUDE_INSTALL_DIR` 环境变量支持
  - 添加参数验证和错误处理
  - 参考需求: 1.1.1 (自定义安装目录参数)

- [x] **1.3 更新帮助文档**
  - 文件: `install.sh`
  - 更新 `show_help` 函数中的安装目录
  - 添加环境变量使用说明
  - 参考需求: 1.1.4 (默认目录使用)

## 2. 配置文件处理

- [x] **2.1 修改配置模板生成逻辑**
  - 文件: `install.sh` (已实现)
  - 添加 `_update_configuration_paths` 函数动态更新配置文件
  - 基于实际安装目录更新所有路径引用
  - 参考需求: 1.2.1 (SWITCHER_DIR 变量初始化)

- [x] **2.2 验证配置正确性**
  - 文件: 安装脚本相关部分
  - 添加安装后配置验证步骤
  - 确保所有路径引用正确
  - 参考需求: 1.2.3 (配置验证)

## 3. 错误处理和验证

- [x] **3.1 实现目录权限检查**
  - 文件: `install.sh`
  - 添加 `check_directory_permissions` 函数
  - 验证目标目录的写入权限
  - 参考需求: 1.1.5 (目录权限验证)

- [x] **3.2 实现目录存在性处理**
  - 文件: `install.sh`
  - 添加 `handle_existing_directory` 函数
  - 处理已存在目录的情况
  - 参考需求: 4.1 (目标目录已存在处理)

- [x] **3.3 实现安装回滚机制**
  - 文件: `install.sh`
  - 添加 `cleanup_on_failure` 函数
  - 安装失败时清理创建的文件
  - 参考需求: 1.3.3 (原子性安装)

## 4. 测试开发

- [x] **4.1 编写单元测试**
  - 文件: `tests/unit/test_install_directory.sh` (已完成)
  - 测试默认安装目录配置
  - 测试环境变量覆盖功能
  - 参考需求: 所有功能需求

- [ ] **4.2 编写集成测试**
  - 文件: `tests/integration/test_custom_install.sh` (新建)
  - 测试完整安装流程到自定义目录
  - 验证配置文件正确性
  - 参考需求: 1.2.4 (配置完整性验证)

- [ ] **4.3 编写边界测试**
  - 文件: `tests/integration/test_edge_cases.sh` (新建)
  - 测试权限不足的情况
  - 测试目录已存在的情况
  - 参考需求: 4.1, 4.2 (边缘情况处理)

## 5. 文档更新

- [x] **5.1 更新 README 安装说明**
  - 文件: `README.md`
  - 说明新的安装目录配置选项
  - 提供环境变量使用示例
  - 参考需求: 1.4.3 (文档说明)

## 实施顺序建议

1. 先完成核心配置修改 (任务1.1-1.3)
2. 然后实现错误处理 (任务3.1-3.3)  
3. 接着开发测试用例 (任务4.1-4.3)
4. 最后更新文档 (任务5.1)

每个任务完成后都应运行相关测试验证功能正确性。